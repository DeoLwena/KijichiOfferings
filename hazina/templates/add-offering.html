{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h3 class="fw-bold text-dark">Kurekodi Matoleo</h3>
            <p class="text-muted">Ingiza taarifa za zaka na sadaka. Unaweza kuongeza mistari mingi kwa mtoaji mmoja.</p>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        <div class="row g-4">
            <div class="col-lg-12">
                <div class="card border-0 shadow-sm p-4" style="border-radius: 25px;">

                    <div class="row mb-4 border-bottom pb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-teal text-uppercase">1. Chagua au Andika Mtoaji (Member)</label>
                            <div class="input-group shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <span class="input-group-text bg-white border-0"><i class="bi bi-person-search"></i></span>
                                <input type="text" name="mtoaji" id="mtoajiInput" class="form-control border-0 p-3" list="watoajiList" placeholder="Tafuta au andika jina jipya..." required>
                                <datalist id="watoajiList">
                                    {% for mtoaji in watoaji %}
                                    <option value="{{ mtoaji.jina_la_kwanza }} {{ mtoaji.jina_la_mwisho }} - {{ mtoaji.namba_ya_ushirika }}">
                                    {% endfor %}
                                </datalist>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-teal text-uppercase">2. Tarehe ya Sabato</label>
                            <input type="date" name="tarehe" class="form-control border-0 bg-light p-3 shadow-sm" style="border-radius: 12px;" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small text-teal text-uppercase">3. Mchanganuo wa Matoleo</label>
                        <div class="table-responsive">
                            <table class="table align-middle" id="offeringTable">
                                <thead class="table-light">
                                    <tr style="font-size: 0.85rem;">
                                        <th class="border-0 px-3">Aina ya Matoleo</th>
                                        <th class="border-0">Idara Husika</th>
                                        <th class="border-0">Kiasi (Tsh)</th>
                                        <th class="border-0 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="offering-row">
                                        <td class="px-3">
                                            <select class="form-select border-0 bg-light p-2 aina-select" name="aina[]" style="border-radius: 8px;" required>
                                                <option value="Z">Zaka</option>
                                                <option value="S">Sadaka</option>
                                                <option value="zS">Zaka na Sadaka</option>
                                                <option value="I">Idara</option>
                                                <option value="M">Mengineyo</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-select border-0 bg-light p-2 idara-select" name="idara[]" style="border-radius: 8px;" disabled>
                                                <option value="">N/A (Sio lazima)</option>
                                                {% for idara in idara_list %}
                                                <option value="{{ idara.id }}">{{ idara.idara }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="kiasi[]" class="form-control border-0 bg-light p-2 kiasi-input" style="border-radius: 8px;" placeholder="0.00" required>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-outline-danger btn-sm border-0 remove-row">
                                                <i class="bi bi-trash3-fill"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="text-start mt-2">
                            <button type="button" id="addRow" class="btn btn-light btn-sm fw-bold px-3 py-2" style="border-radius: 10px; color: var(--sda-teal);">
                                <i class="bi bi-plus-circle-dotted me-2"></i> Ongeza Mstari Mwengine
                            </button>
                        </div>
                    </div>

                    <div class="mt-5 border-top pt-4 text-end">
                        <div class="mb-3">
                            <span class="text-muted me-3">Jumla Kuu ya Maingizo:</span>
                            <span class="h4 fw-bold text-dark" id="grandTotal">Tsh 0.00</span>
                        </div>
                        <button type="submit" class="btn btn-teal px-5 py-3 shadow" style="background: var(--sda-teal-gradient); color: white; border-radius: 15px; border: none; font-weight: 700;">
                            <i class="bi bi-cloud-arrow-up-fill me-2"></i> Hifadhi Matoleo Yote
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // Function to handle enabling/disabling of the Department dropdown
    function toggleIdaraField(selectElement) {
        const row = selectElement.closest('tr');
        const idaraSelect = row.querySelector('.idara-select');

        // Enable if value is "Idara" (I) or "Mengineyo" (M)
        if (selectElement.value === 'I' || selectElement.value === 'M') {
            idaraSelect.disabled = false;
            idaraSelect.required = true;
            idaraSelect.classList.remove('bg-light'); // Visual cue it's active
        } else {
            idaraSelect.disabled = true;
            idaraSelect.required = false;
            idaraSelect.value = ""; // Reset value
            idaraSelect.classList.add('bg-light');
        }
    }

    // Global listener for Aina selection
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('aina-select')) {
            toggleIdaraField(e.target);
        }
    });

    document.getElementById('addRow').addEventListener('click', function() {
        const tableBody = document.querySelector('#offeringTable tbody');
        const firstRow = document.querySelector('.offering-row');
        const newRow = firstRow.cloneNode(true);

        // Reset values
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelectorAll('select').forEach(select => select.selectedIndex = 0);

        // Ensure new row starts with Idara disabled
        const idaraSelect = newRow.querySelector('.idara-select');
        idaraSelect.disabled = true;
        idaraSelect.required = false;

        tableBody.appendChild(newRow);
        attachRemoveEvent();
    });

    function attachRemoveEvent() {
        document.querySelectorAll('.remove-row').forEach(button => {
            button.onclick = function() {
                const rows = document.querySelectorAll('.offering-row');
                if (rows.length > 1) {
                    this.closest('tr').remove();
                    calculateTotal();
                } else {
                    alert("Lazima uwe na angalau mstari mmoja.");
                }
            };
        });
    }

    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('kiasi-input')) {
            calculateTotal();
        }
    });

    function calculateTotal() {
        let total = 0;
        document.querySelectorAll('.kiasi-input').forEach(input => {
            const val = parseFloat(input.value) || 0;
            total += val;
        });
        document.getElementById('grandTotal').innerText = 'Tsh ' + total.toLocaleString();
    }

    attachRemoveEvent();
</script>
{% endblock %}